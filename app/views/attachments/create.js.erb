<% if @attachment.new_record? %>
  alert('Не удалось загрузить файл. <%= @attachment.errors_as_text %>' );
<% else %>
  var attachments = $('.js-uploading').closest('.js-new-message').find('.js-attachments');
  var attachment_ids = attachments.closest('.js-new-message').find('#message_attachment_ids');
  var ids = attachment_ids.val();
  if (ids === '[]') { 
    ids = '<%= @attachment.id %>';
  } else {
    ids = ids + ',<%= @attachment.id %>';
  }
  attachment_ids.val(ids);
  $('.js-uploading').removeClass('js-uploading');
  attachments.append("<%=j render @attachment %>")
<% end %>